# Research: 登校時間変更時のロールメンション

## Unknowns to Resolve
- 設定単位: サーバー/チャンネル/通知タイプ（変更通知）のどれでロール指定を行うか
- 抑制ポリシー: 時間窓/イベントID/当日1回のいずれを採用するか、組み合わせるか
- 通常時刻の定義源: `src/school_policy.py` など既存ポリシーからの参照と例外日扱い
- 対象限定: 学年/クラス/コースなどロール粒度の選択可否
- 無効ロール時の通知: どこに通知（運用チャンネル/管理者DM/ログのみ）

## Findings
### Discord ロールメンションと Webhook
- discord.py の SyncWebhook 送信では `content` に `<@&ROLE_ID>` を含めることでロールメンション可能
- Allowed Mentions の制御で過剰メンションを抑制可能（既定ではロールメンションは有効）
- 埋め込み（Embed）のみ送るとメンションは発火しないため、content を併用するのが安全

### 去重/抑制戦略
- 「通知キー」= 日付（YYYY-MM-DD）× 種別（登校時刻変更）× 対象チャンネル（ID）× 対象範囲（全体/学年） など
- 短時間の再通知（例: 10分以内）はメンションなしで更新通知を送る、など段階的抑制度が有効
- 既存 `src/storage.py`（JSON ベース）のキー・値で十分に実現可能

### 通常時刻の定義
- 既存の `src/school_policy.py` に通常登校や判定時刻の情報があるため、そこを参照
- 未定義/新年度直後は安全側（メンションなし）で告知のみ

## Decisions
- 設定単位: まずはサーバー単位のロールID設定（将来チャンネル上書きを検討）
- 抑制ポリシー: 同一日・同一チャンネル・同一通知種別でメンションは一回まで（24h 窓）。更新はメンションなし
- 通常時刻の定義: `school_policy` で取得し、なければメンションなし
- 無効ロール時: エラーをログ WARN とし、運用チャンネルへの注意喚起は以降の拡張

## Alternatives Considered
- チャンネル別上書き設定: 早期は複雑性が大きく見送り。利用要望次第で拡張
- 時間窓のみの抑制: 日跨ぎ問題があり「同一日一回」基準の方が運用しやすい

## Next Steps
- Data model に RoleMentionSetting と SuppressKey の定義を反映
- Contract で content と Embed の併用要件を明記
